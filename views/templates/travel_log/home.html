{% extends 'travel_log/layout.html' %}

{% block head %}
{{ super() }}

{% include 'travel_log/mapbox-header.html' %}
<link rel="stylesheet" href="{{ url_for('static', filename='travel_log/mapbox-styles.css' )}}">

<script src="{{ url_for('static', filename='travel_log/mapbox.js') }}"></script>

<script>
    $(document).ready(function (){
        var coords = {{ data.coords | safe }};
        globalCoords = [];
        for (const point of coords.points){
            globalCoords.push(point.geometry.coordinates)
        }
        globalTripID = coords.points[0].properties.trip_id
        map_bounds = get_map_bounds(coords);
        map_center = map_bounds.getCenter()
        create_trip_map(map_center);
        // match the route to the roads
        set_markers(coords);
    })

</script>

{% endblock head %}


{% block body %}
<div id="log-body-contain" class="w3-mobile">
{% if not 'user' in session %}
    <div id="login-section">
        <h2>Welcome to Travel Log!</h2>
        <p id="login" class="w3-button w3-white w3-round-large w3-large"><a href="{{ url_for('travel_log.login') }}" >Sign in</a></p>
        <p id="new-account"><a href="{{ url_for('travel_log.new_account') }}" >Create an Account</a></p>
        
    </div>
{% else %}
    <div id="trip-list-contain " >
        {% if data.trip %}
        <div id="new_log_button" >
            <p class="w3-hide-medium w3-hide-small " style="height:20pt;">&nbsp;</p>
            <p><a class="w3-btn w3-circle w3-xlarge w3-primary-color " href="{{ url_for('.add_log')}}" ><strong>&plus;</strong></a></p>
        </div>
        <div id="trip-list-contain" >
            <h3 id="trip_name" class="w3-primary-color"  
                title="Click to edit Trip" onclick="window.location='{{url_for("travel_log.edit_trip")}}
                {{data.trip.id}}/?next={{ g.listURL }}'">
                {{data.trip.name}}
                {% if data.log_entries %}
                    <span class="w3-hide-small">&nbsp;&nbsp;&mdash;&nbsp;&nbsp;{{data.log_entries[0].entry_date | abbr_date_string }}</span>
                    <span class="w3-hide-medium w3-hide-large"><br>{{data.log_entries[0].entry_date | abbr_date_string }}</span>
                {% endif %}
            </h3>
            {% if data.log_entries %}
            <div id="trip_stats_left" >
                <p><strong>Car: </strong>{{ data.log_entries[0].vehicle_name | default('??',True)}}</p>
            </div>
            <div id="trip_stats_right" >
            </div>
            <div class="w3-row" >
                <p class="w3-col m3 l3 s6"><strong>Dist:</strong> {{ data.log_entries[0].trip_distance }}mi.</p>
                <p class="w3-col m3 l3 s6"><strong>Eff:</strong> 
                    {% if data.trip_consumption > 0%}
                    {{ (data.log_entries[0].trip_distance / data.trip_consumption) | round(2) }}{{ data.log_entries[0].efficiency_factor }}</p>
                    {% else %}
                    0
                    {% endif %}
                <p class="w3-col m3 l3 s6"><strong>kWh:</strong> {{ data.trip_consumption | round(2) }}</p>
                <p class="w3-col m3 l3 s6"><strong>Cost:</strong> {{ data.log_entries[0].trip_fuel_cost | default(0,True) | money('$') }}</p>
            </div>
        <div id="home-trip-list" >
        {% for rec in data.log_entries %}
            {% if rec.entry_type != "WAY" %}
                <div  onclick="window.location='{{url_for("travel_log.edit_log")}}{{rec.id}}/?next={{ g.listURL }}'">
                    <div class="log_title_row w3-row w3-row-padding w3-secondary-color" >
                        <h4 class="w3-col  m8 l8 s8" ><span style="font-size:small;">({{ rec.entry_type | truncate(3,True,'',0) | upper }})</span> {{rec.location_name}}</h4>
                        <p class="w3-col  m4 l4 s4 w3-right-align" >{{ rec.entry_date | short_abbr_date_string }}, {{ rec.entry_date | local_time_string}}</p>
                    </div>
                    <p class="w3-row-padding"><strong>Dist:</strong> {{ rec.leg_distance }}mi.</p>
                    <div class="w3-row w3-row-padding" >
                        <p class="w3-col m3 l3 s6"><strong>Eff:</strong> {{ rec.leg_efficiency | round(2) }}{{ rec.efficiency_factor }}</p>
                        <p class="w3-col m3 l3 s6"><strong>SOC:</strong> {{ rec.state_of_charge | default(0,True) }}%</p>
                        <p class="w3-col m3 l3 s6"><strong>kWh:</strong> {{ rec.consumption | round(2) | default(0,True) }}</p>
                        <p class="w3-col m3 l3 s6"><strong>Cost:</strong> {{ rec.cost | default(0,True) | money('$') }}</p>
                    </div>
                </div>
                    {% if rec.memo %}
                    <div id="log_memo_contain" >
                        <div class="w3-row w3-row-padding memo " >
                            <p id="log_memo_{{ rec.id }}" class="w3-col log_memo more" onclick="show_more('log_memo_{{ rec.id }}')">{{ rec.memo | more | sanitize  | safe }}</p>
                        </div>
                    </div>
                   {% endif %}
                {% endif %}
            {% endfor %}
            </div>
            <!--
            <div id="loc" class="w3-row w3-row-padding">
                <p class="w3-col m3 l3 s6">Current Longitude</p>
                <p id="geoLng" class="w3-col m3 l3 s6">Unknown</p>
            </div>
            <div id="loc" class="w3-row w3-row-padding">
                <p class="w3-col m3 l3 s6">Current Latitude</p>
                <p id="geoLat" class="w3-col m3 l3 s6">Unknown</p>
            </div>
            -->
            <div id="map" class="map"></div>
            
        </div>
            {% else %}
                <p class="no_log" >No Log Entires Yet...</br> <a href="{{url_for('travel_log.edit_log')}}0/?next={{ g.listURL }}" class="w3-button w3-round w3-primary-color" >Add Entry</a></p>
            {% endif %}
        {% else %}
            <p class="no_trip">
                You are not currenly on a Trip.<br/>
                <a href="{{url_for('travel_log.edit_trip')}}0/?next={{ g.listURL }}" class="w3-button w3-round w3-primary-color" >Start a Trip?</a>
            </p>
        {% endif %}
    </div>
{% endif %}
</div>
{% endblock body %}